#include "lcd.h"

	/*PORT 0*/
	uint32_t E = ((uint32_t)1<<27); 		//P0.27
	uint32_t BACKLIGHT = ((uint32_t)1<<28); //P0.28
	uint32_t RST = ((uint32_t)1<<29); 		//P0.29
	uint32_t CS2 = ((uint32_t)1<<30); 		//P0.30

	/*PORT 1*/
	uint32_t CS1 = ((uint32_t)1<<18); //P1.18
	uint32_t D0 = ((uint32_t)1<<19); //P1.19
	uint32_t D1 = ((uint32_t)1<<20); //P1.20
	uint32_t D2 = ((uint32_t)1<<21); //P1.21
	uint32_t D3 = ((uint32_t)1<<22); //P1.22
	uint32_t D4 = ((uint32_t)1<<23); //P1.23
	uint32_t D5 = ((uint32_t)1<<24); //P1.24
	uint32_t D6 = ((uint32_t)1<<25); //P1.25
	uint32_t D7 = ((uint32_t)1<<26); //P1.26

	/*PORT 2*/
	uint32_t LCD_PWR = ((uint32_t)1<<11); //P2.11

	/*PORT 3*/
	uint32_t RS = ((uint32_t)1<<26);	//P3.26
	uint32_t RW = ((uint32_t)1<<25);	//P3.25



	const char TEXT[95][5] =
	{
		{0x00, 0x00, 0x00, 0x00, 0x00}, // SPACE
		{0x00, 0x00, 0x5F, 0x00, 0x00}, // !
		{0x00, 0x03, 0x00, 0x03, 0x00}, // "
		{0x14, 0x3E, 0x14, 0x3E, 0x14}, // #
		{0x24, 0x2A, 0x7F, 0x2A, 0x12}, // $
		{0x43, 0x33, 0x08, 0x66, 0x61}, // %
		{0x36, 0x49, 0x55, 0x22, 0x50}, // &
		{0x00, 0x05, 0x03, 0x00, 0x00}, // '
		{0x00, 0x1C, 0x22, 0x41, 0x00}, // (
		{0x00, 0x41, 0x22, 0x1C, 0x00}, // )
		{0x14, 0x08, 0x3E, 0x08, 0x14}, // *
		{0x08, 0x08, 0x3E, 0x08, 0x08}, // +
		{0x00, 0x50, 0x30, 0x00, 0x00}, // , 12
		{0x00, 0x08, 0x08, 0x08, 0x00}, // - 13
		{0x00, 0x60, 0x60, 0x00, 0x00}, // . 14
		{0x20, 0x10, 0x08, 0x04, 0x02}, // / 15
		{0x3E, 0x51, 0x49, 0x45, 0x3E}, // 0 16
		{0x00, 0x04, 0x02, 0x7F, 0x00}, // 1
		{0x42, 0x61, 0x51, 0x49, 0x46}, // 2
		{0x22, 0x41, 0x49, 0x49, 0x36}, // 3
		{0x18, 0x14, 0x12, 0x7F, 0x10}, // 4
		{0x27, 0x45, 0x45, 0x45, 0x39}, // 5
		{0x3E, 0x49, 0x49, 0x49, 0x32}, // 6
		{0x01, 0x01, 0x71, 0x09, 0x07}, // 7
		{0x36, 0x49, 0x49, 0x49, 0x36}, // 8
		{0x26, 0x49, 0x49, 0x49, 0x3E}, // 9
		{0x00, 0x36, 0x36, 0x00, 0x00}, // :
		{0x00, 0x56, 0x36, 0x00, 0x00}, // ;
		{0x08, 0x14, 0x22, 0x41, 0x00}, // <
		{0x14, 0x14, 0x14, 0x14, 0x14}, // =
		{0x00, 0x41, 0x22, 0x14, 0x08}, // >
		{0x02, 0x01, 0x51, 0x09, 0x06}, // ?
		{0x3E, 0x41, 0x59, 0x55, 0x5E}, // @
		{0x7E, 0x09, 0x09, 0x09, 0x7E}, // A
		{0x7F, 0x49, 0x49, 0x49, 0x36}, // B
		{0x3E, 0x41, 0x41, 0x41, 0x22}, // C
		{0x7F, 0x41, 0x41, 0x41, 0x3E}, // D
		{0x7F, 0x49, 0x49, 0x49, 0x41}, // E
		{0x7F, 0x09, 0x09, 0x09, 0x01}, // F
		{0x3E, 0x41, 0x41, 0x49, 0x3A}, // G
		{0x7F, 0x08, 0x08, 0x08, 0x7F}, // H
		{0x00, 0x41, 0x7F, 0x41, 0x00}, // I
		{0x30, 0x40, 0x40, 0x40, 0x3F}, // J
		{0x7F, 0x08, 0x14, 0x22, 0x41}, // K
		{0x7F, 0x40, 0x40, 0x40, 0x40}, // L
		{0x7F, 0x02, 0x0C, 0x02, 0x7F}, // M
		{0x7F, 0x02, 0x04, 0x08, 0x7F}, // N
		{0x3E, 0x41, 0x41, 0x41, 0x3E}, // O
		{0x7F, 0x09, 0x09, 0x09, 0x06}, // P
		{0x1E, 0x21, 0x21, 0x21, 0x5E}, // Q
		{0x7F, 0x09, 0x09, 0x09, 0x76}, // R
		{0x26, 0x49, 0x49, 0x49, 0x32}, // S
		{0x01, 0x01, 0x7F, 0x01, 0x01}, // T
		{0x3F, 0x40, 0x40, 0x40, 0x3F}, // U
		{0x1F, 0x20, 0x40, 0x20, 0x1F}, // V
		{0x7F, 0x20, 0x10, 0x20, 0x7F}, // W
		{0x41, 0x22, 0x1C, 0x22, 0x41}, // X
		{0x07, 0x08, 0x70, 0x08, 0x07}, // Y
		{0x61, 0x51, 0x49, 0x45, 0x43}, // Z
		{0x00, 0x7F, 0x41, 0x00, 0x00}, // [
		{0x02, 0x04, 0x08, 0x10, 0x20}, // \ //
		{0x00, 0x00, 0x41, 0x7F, 0x00}, // ]
		{0x04, 0x02, 0x01, 0x02, 0x04}, // ^
		{0x40, 0x40, 0x40, 0x40, 0x40}, // _
		{0x00, 0x01, 0x02, 0x04, 0x00}, // `
		{0x20, 0x54, 0x54, 0x54, 0x78}, // a
		{0x7F, 0x44, 0x44, 0x44, 0x38}, // b
		{0x38, 0x44, 0x44, 0x44, 0x44}, // c
		{0x38, 0x44, 0x44, 0x44, 0x7F}, // d
		{0x38, 0x54, 0x54, 0x54, 0x18}, // e
		{0x04, 0x04, 0x7E, 0x05, 0x05}, // f
		{0x08, 0x54, 0x54, 0x54, 0x3C}, // g
		{0x7F, 0x08, 0x04, 0x04, 0x78}, // h
		{0x00, 0x44, 0x7D, 0x40, 0x00}, // i
		{0x20, 0x40, 0x44, 0x3D, 0x00}, // j
		{0x7F, 0x10, 0x28, 0x44, 0x00}, // k
		{0x00, 0x41, 0x7F, 0x40, 0x00}, // l
		{0x7C, 0x04, 0x78, 0x04, 0x78}, // m
		{0x7C, 0x08, 0x04, 0x04, 0x78}, // n
		{0x38, 0x44, 0x44, 0x44, 0x38}, // o
		{0x7C, 0x14, 0x14, 0x14, 0x08}, // p
		{0x08, 0x14, 0x14, 0x14, 0x7C}, // q
		{0x00, 0x7C, 0x08, 0x04, 0x04}, // r
		{0x48, 0x54, 0x54, 0x54, 0x20}, // s
		{0x04, 0x04, 0x3F, 0x44, 0x44}, // t
		{0x3C, 0x40, 0x40, 0x20, 0x7C}, // u
		{0x1C, 0x20, 0x40, 0x20, 0x1C}, // v
		{0x3C, 0x40, 0x30, 0x40, 0x3C}, // w
		{0x44, 0x28, 0x10, 0x28, 0x44}, // x
		{0x0C, 0x50, 0x50, 0x50, 0x3C}, // y
		{0x44, 0x64, 0x54, 0x4C, 0x44}, // z
		{0x00, 0x08, 0x36, 0x41, 0x41}, // {
		{0x00, 0x00, 0x7F, 0x00, 0x00}, // |
		{0x41, 0x41, 0x36, 0x08, 0x00}, // }
		{0x02, 0x01, 0x02, 0x04, 0x02}  // ~
	};

	const char NUMBERS_LARGE[10][5]= /* 5x7*/
		{
			{0x3E, 0x51, 0x49, 0x45, 0x3E}, // 0
			{0x00, 0x04, 0x02, 0x7F, 0x00}, // 1
			{0x42, 0x61, 0x51, 0x49, 0x46}, // 2
			{0x22, 0x41, 0x49, 0x49, 0x36}, // 3
			{0x18, 0x14, 0x12, 0x7F, 0x10}, // 4
			{0x27, 0x45, 0x45, 0x45, 0x39}, // 5
			{0x3E, 0x49, 0x49, 0x49, 0x32}, // 6
			{0x01, 0x01, 0x71, 0x09, 0x07}, // 7
			{0x36, 0x49, 0x49, 0x49, 0x36}, // 8
			{0x26, 0x49, 0x49, 0x49, 0x3E} // 9
		};


	const char NUMBERS_SMALL[10][3]= /* 3x5 */
		{
			{0x3E,0x22,0x3E},
			{0x08,0x04,0x3E},
			{0x3A,0x2A,0x2E},
			{0x2A,0x2A,0x3E},
			{0x0E,0x08,0x3E},
			{0x2E,0x2A,0x3A},
			{0x3E,0x2A,0x3A},
			{0x02,0x02,0x3E},
			{0x3E,0x2A,0x3E},
			{0x2E,0x2A,0x3E}
		};





/*********************************************************************
 *  RESET GRAPHIC LCD
 *
 *  RST_STATE_ = 1 - LCD IN RESET MODE
 *  RST_STATE_ = 0 - LCD IN NORMAL MODE
**********************************************************************/
void lcd_reset(_Bool RST_STATE_)
	{
		if(RST_STATE_)
		{
			GPIO_SetValue(0, RST);
		}
		else
		{
			GPIO_ClearValue(0, RST);
		}
	}



/*********************************************************************
 *  GRAPHIC LCD POWER [5 VOLTS]
 *
 *  ON_OFF_STATE_ = 1 - TURN POWER SUPPLY ON
 *  ON_OFF_STATE_ = 0 - TURN POWER SUPPLY OFF
**********************************************************************/
void lcd_on_off(_Bool ON_OFF_STATE_)
	{
		if(ON_OFF_STATE_)
		{
			GPIO_SetValue(2, LCD_PWR);
		}
		else
		{
			GPIO_ClearValue(2, LCD_PWR);
		}
	}

void lcd_io_set_directions(void)
{
    /* %%% OUTPUTS %%% */
    GPIO_SetDir(0, BACKLIGHT | CS2 | E | RST ,1); 					// PORT0
    GPIO_SetDir(1, CS1 | D0 | D1 | D2 | D3 | D4 | D5 | D6 | D7, 1); // PORT1
    GPIO_SetDir(2, LCD_PWR,1 ); 									// PORT2
    GPIO_SetDir(3, RS | RW, 1); 									// PORT3
}

void lcd_write_byte(uint8_t lcd_half_, _Bool data, uint8_t byte_)
{
	switch (lcd_half_)
	{
		case 1:	output_low(CS1_); output_high(CS2_); 	break;
		case 2: output_high(CS1_); output_low(CS2_); 	break;
		default:output_low(CS1_); output_low(CS2_); 	break;
	}
	GPIO_SetValue(0, E);
	GPIO_ClearValue(3, RW);

	if(data)	//SET RS LOW/HIGH
		{
			GPIO_SetValue(3, RS);
		}
	else
		{
			GPIO_ClearValue(3, RS);
		}

/*
xxxx xxxx xxxx xxxx xxxx xxxx xxxx xxxx
1098 7654 3210 9876 5432 1098 7654 3210
0000 0111 1111 1000 0000 0000 0000 0000
 */

    GPIO_ClearValue(1, D0 | D1 | D2 | D3 | D4 | D5 | D6 | D7);

	//DATA_PORT = byte_;
	if(byte_ & 0b00000001) GPIO_SetValue(1, D0);
	if(byte_ & 0b00000010) GPIO_SetValue(1, D1);
	if(byte_ & 0b00000100) GPIO_SetValue(1, D2);
	if(byte_ & 0b00001000) GPIO_SetValue(1, D3);
	if(byte_ & 0b00010000) GPIO_SetValue(1, D4);
	if(byte_ & 0b00100000) GPIO_SetValue(1, D5);
	if(byte_ & 0b01000000) GPIO_SetValue(1, D6);
	if(byte_ & 0b10000000) GPIO_SetValue(1, D7);

	for (int var = 0; var < 0xfff; ++var) {
		__NOP();
	}

    GPIO_ClearValue(0, E);
}

void lcd_init_on_off(_Bool STATE)
	{
		lcd_write_byte(0, 0, 0b00111110 | STATE);
	}


void lcd_goto(uint8_t LINE_, uint8_t X_)
	{

		if(LINE_ != -1)	lcd_write_byte(0,0, 0b10111000 | (0b00000111 & LINE_));
		if(X_ != -1)	lcd_write_byte(0,0, 0b01000000 | (0b00111111 & X_));
	}



uint8_t lcd_status(void) //READ
	{
		//NEED TO DEFINE RS,E RW PINS
		//_Bool RESET_STATE, POWER, BUSY;
		uint32_t status;

		/*	%%% INPUTS %%%	*/
	    GPIO_SetDir(1, D4 | D5 | D7, 0); // PORT1



	     //   if(send_msg_to_dut1.all > 0)
	    //    {
	    //        if(send_msg_to_dut1.bit.serial_nr)

		output_low(RS_);
		output_high(RW_);
		output_high(E_);

		status = GPIO_ReadValue(1);
		lcd_status_union.bit.RESET_STATE = ((status & 1<<23) >> 23);
		lcd_status_union.bit.POWER = ((status & 1<<24) >> 24);
		lcd_status_union.bit.BUSY = ((status & 1<<26) >> 26);

	//	lcd_status_union.all
	 //   UART_SendByte(DUT1,lcd_status_union.all + 0x30);


		/*	%%% OUTPUTS %%%	*/
	    GPIO_SetDir(1, D4 | D5 | D7, 1); // PORT1

		return((int)lcd_status_union.all);
	}
// 0/3/20/50


// lcd_clear_page(0,3,5,7); - Nodzeesiis, 0.,1.,2. liinijaa, 5,6,7 pikseljus !! pikselji saakas ar 0 poziiciju
void lcd_clear_page(uint8_t page_start, uint8_t page_cnt, uint8_t x_start, uint8_t x_end)
{
	//lcd_write_byte(0,1,0xd0);
	uint8_t i,j;
	uint8_t side;
	for(j = page_start; j <page_start+page_cnt; j++) // 257 - X END, I = XSTART
	{
		lcd_goto(j,x_start);

		for(i = x_start; i <= x_end; i++) // 257 - X END, I = XSTART
		{
			if(i <= 63) side = LEFT_;
			else if(i == 64) {lcd_write_byte(0,0, 0b01000000); side = RIGHT_;}
			else side = RIGHT_;
			lcd_write_byte(side,1,0x0);
		}
	}
}

void lcd_putc(uint8_t xpos, char char_,uint8_t font_, _Bool space_)
	{
		uint8_t side;
		if(font_ != 0 && (char_ > '9' || char_ < '0'))
			{
				FONTS = TXT;
			}

		uint8_t i;
		if(font_ == NUMBERS_S) // mazie cipari
		{
			for(i = 0; i < 3; i++)
			{
				if(xpos <= 63) side = LEFT_;
				else if(xpos == 64) {lcd_write_byte(0,0, 0b01000000); side = RIGHT_;} // goto x = 0, side 2
				else side = RIGHT_;
				xpos++;

				lcd_write_byte(side,1,NUMBERS_SMALL[char_ - 0x30][i]);
			}
		}
		else if (font_ == NUMBERS_XL) // lielie cipari
			{
				for(i = 0; i < 5; i++)
				{
					if(xpos <= 63) side = LEFT_;
					else if(xpos == 64) {lcd_write_byte(0,0, 0b01000000); side = RIGHT_;} // goto x = 0, side 2
					else side = RIGHT_;
					xpos++;

					lcd_write_byte(side,1,NUMBERS_LARGE[char_ - 0x30][i]);
				}
			}
		else //teksts
			{
				for(i = 0; i < 5; i++)
				{
					if(xpos <= 63) side = LEFT_;
					else if(xpos == 64) {lcd_write_byte(0,0, 0b01000000); side = RIGHT_;} // goto x = 0, side 2
					else side = RIGHT_;
					xpos++;

					lcd_write_byte(side,1,TEXT[char_ - 0x20][i]);
				}
			}

		if(space_)
		{
			if(xpos <= 63) side = LEFT_;
			else if(xpos == 64) {lcd_write_byte(0,0, 0b01000000); side = RIGHT_;} // goto x = 0, side 2
			else side = RIGHT_;
			space(side);
		}
	}

void lcd_puts(uint8_t xpos, char* string_, uint8_t font_, _Bool space_)
	{
		while(*string_ != 0)
			{
				lcd_putc(xpos,*string_,TXT,space_);
				*string_++;
				xpos = xpos + 5;
				if (space_)
				{
					xpos++;
				}
			}
	}
